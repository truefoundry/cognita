# Build Stage
FROM node:22 AS build-step
WORKDIR /build
COPY . .

# Install dependencies
RUN yarn install --frozen-lockfile

# Define build arguments
ARG VITE_DOCS_QA_DELETE_COLLECTIONS
ARG VITE_DOCS_QA_ENABLE_REDIRECT
ARG VITE_DOCS_QA_MAX_UPLOAD_SIZE_MB
ARG VITE_DOCS_QA_STANDALONE_PATH
ARG VITE_GTAG_ID
ARG VITE_QA_FOUNDRY_URL
ARG VITE_USE_LOCAL
ARG VITE_USE_RELATIVE_BASE_URL
ARG VITE_CARBON_API_KEY

# Set environment variables from build arguments
ENV VITE_DOCS_QA_DELETE_COLLECTIONS=${VITE_DOCS_QA_DELETE_COLLECTIONS} \
  VITE_DOCS_QA_ENABLE_REDIRECT=${VITE_DOCS_QA_ENABLE_REDIRECT} \
  VITE_DOCS_QA_MAX_UPLOAD_SIZE_MB=${VITE_DOCS_QA_MAX_UPLOAD_SIZE_MB} \
  VITE_DOCS_QA_STANDALONE_PATH=${VITE_DOCS_QA_STANDALONE_PATH} \
  VITE_GTAG_ID=${VITE_GTAG_ID} \
  VITE_QA_FOUNDRY_URL=${VITE_QA_FOUNDRY_URL} \
  VITE_USE_LOCAL=${VITE_USE_LOCAL} \
  VITE_USE_RELATIVE_BASE_URL=${VITE_USE_RELATIVE_BASE_URL} \
  VITE_CARBON_API_KEY=${VITE_CARBON_API_KEY}

# Build the project
RUN yarn build

# Production Stage
FROM node:18.2.0 AS production-stage
RUN npm install -g serve
WORKDIR /app
COPY --from=build-step /build/dist /app/dist

EXPOSE 5000
CMD ["serve", "-s", "dist", "-l", "5000"]
